<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>eBird Michigan Summary</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üê¶</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js?v=1"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js?v=1"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(to right, #e0f7fa, #e1f5fe);
      color: #333;
    }

    body.dark-mode {
      background: #121212; /* Dark background */
      color: #e0e0e0; /* Light text color */
    }

    h2 {
      text-align: center;
      color: #00796b;
      margin-bottom: 30px;
    }

    body.dark-mode h2 {
      color: #80cbc4;
    }

    .life-summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: #ffffffcc;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }

    body.dark-mode .life-summary-table {
      background: #1e1e1e;
      color: #e0e0e0;
      border-color: #444;
    }

    .life-summary-table th, .life-summary-table td {
      padding: 12px 15px;
      border: 1px solid #ccc;
      text-align: left;
    }

    /* Center-align the second and third columns in the life summary table */
    .life-summary-table td:nth-child(2),
    .life-summary-table td:nth-child(3) {
        text-align: center;
    }

    body.dark-mode .life-summary-table th,
    body.dark-mode .life-summary-table td {
      border-color: #444;
    }

    .life-summary-table th {
      background-color: #00796b;
      color: #fff;
      text-align: center;
    }

    body.dark-mode .life-summary-table th {
      background-color: #004d40;
    }

    .life-summary-table tr:nth-child(even) {
      background-color: #f1f8e9;
    }

    body.dark-mode .life-summary-table tr:nth-child(even) {
      background: #252525;
    }

    .life-summary-table tr:hover {
      background-color: #c8e6c9;
    }

    body.dark-mode .life-summary-table tr:hover {
      background: #444;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 15px;
      gap: 10px;
    }

    body.dark-mode .tabs {
      background: #1e1e1e;
    }

    .tab {
      padding: 10px 20px;
      background: #b2ebf2;
      border-radius: 25px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    body.dark-mode .tab {
      background: #333;
      color: #b3e5fc;
    }

    .tab:hover {
      background: #4dd0e1;
      color: #fff;
    }

    body.dark-mode .tab:hover {
      background: #004d40;
    }

    .tab.active {
      background: #00796b;
      color: #fff;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    body.dark-mode .tab.active {
      background: #00796b;
      color: #fff;
    }

    .tab-content {
      display: none;
      background: #ffffffee;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }

    body.dark-mode .tab-content {
      background: #1e1e1e;
      border: 1px solid #333;
    }

    .tab-content.active {
      display: block;
    }

    input[type="file"] {
      padding: 10px;
      border: 2px dashed #80deea;
      border-radius: 10px;
      background-color: #e0f7fa;
      transition: all 0.3s ease;
    }

    body.dark-mode input[type="file"] {
      background-color: #333;
      color: #fff;
      border-color: #555;
    }

    input[type="file"]:hover {
      background: #b2ebf2;
      cursor: pointer;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      table-layout: auto;
    }

    body.dark-mode table {
      background: #1e1e1e;
      color: #e0e0e0;
      border-color: #444;
    }

    th, td {
      padding: 12px 15px;
      border: 1px solid #ccc;
      text-align: left;
    }

    body.dark-mode th,
    body.dark-mode td {
      border-color: #444;
    }

    th {
      background: #00796b;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 2;
      cursor: pointer;
      user-select: none;
    }

    body.dark-mode th {
      background: #004d40;
    }

    th.sort-asc::after { content: " üîº"; }
    th.sort-desc::after { content: " üîΩ"; }

    tr:nth-child(even) {
      background: #f1f8e9;
    }

    body.dark-mode tr:nth-child(even) {
      background: #252525;
    }

    tr:nth-child(odd) {
      background: #e8f5e9;
    }

    body.dark-mode tr:nth-child(odd) {
      background: #2c2c2c;
    }

    tr:hover {
      background: #c8e6c9;
      transition: background 0.2s ease;
    }

    body.dark-mode tr:hover {
      background: #444;
    }

    #summaryBox {
      font-size: 1.1em;
      margin-bottom: 15px;
      background: #f1f8e9;
      padding: 10px 15px;
      border-left: 5px solid #4caf50;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    body.dark-mode #summaryBox {
      background: #2c2c2c;
      border-left-color: #4caf50;
      color: #e0e0e0;
    }

    body.dark-mode select,
    body.dark-mode button {
      background-color: #333;
      color: #fff;
      border: 1px solid #555;
    }
    
    button {
        padding: 5px 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    button:hover {
        background-color: #e0e0e0;
    }
    body.dark-mode button:hover {
        background-color: #555;
    }


    body.dark-mode ul#speciesList,
    body.dark-mode ul#countySpeciesList,
    body.dark-mode ul#monthNeedsSpeciesMissingList,
    body.dark-mode ul#monthNeedsSpeciesSeenList,
    body.dark-mode ul#monthNeedsSpeciesNotSeenList {
      color: #e0e0e0;
    }

    /* Styles for the new Month Needs tab */
    .month-needs-container {
      display: flex;
      flex-wrap: wrap; /* Allow wrapping on smaller screens */
      gap: 30px;
      justify-content: space-around;
      margin-top: 20px;
    }

    .month-needs-section {
      flex: 1; /* Distribute space equally */
      min-width: 300px; /* Minimum width before wrapping */
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #f9f9f9;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    body.dark-mode .month-needs-section {
      background-color: #2a2a2a;
      border-color: #444;
    }

    .month-needs-section h3 {
      margin-top: 0;
      color: #00796b;
      text-align: center;
    }

    body.dark-mode .month-needs-section h3 {
      color: #80cbc4;
    }

    .month-needs-section select {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    body.dark-mode .month-needs-section select {
      background-color: #3e3e3e;
      color: #e0e0e0;
      border-color: #555;
    }

    .month-needs-section ul {
      list-style-type: none;
      padding: 0;
      columns: 2; /* Two columns for lists */
      column-gap: 20px;
      max-height: 400px; /* Limit height for scrollability */
      overflow-y: auto; /* Add scrollbar if content overflows */
      border: 1px solid #eee;
      padding: 10px;
      border-radius: 5px;
      background-color: #fff;
    }

    body.dark-mode .month-needs-section ul {
      background-color: #1a1a1a;
      border-color: #333;
    }

    .month-needs-section ul li {
      padding: 5px 0;
      border-bottom: 1px dashed #eee;
    }

    body.dark-mode .month-needs-section ul li {
      border-bottom: 1px dashed #3a3a3a;
    }

    .month-needs-section ul li:last-child {
      border-bottom: none;
    }

    #totalMonthsSpeciesCount {
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 20px;
      color: #004d40;
    }

    body.dark-mode #totalMonthsSpeciesCount {
      color: #b2dfdb;
    }
    
    /* Custom tooltip styles for County Chase */
    .tooltip {
        position: relative;
        display: inline-block;
        cursor: pointer;
        text-decoration: underline;
        text-decoration-style: dotted;
    }
    .tooltip .tooltip-text {
        visibility: hidden;
        width: 320px;
        max-height: 400px;
        overflow-y: auto;
        background-color: #333;
        color: #fff;
        text-align: left;
        border-radius: 6px;
        padding: 10px;
        position: absolute;
        z-index: 10;
        bottom: 125%;
        left: 50%;
        margin-left: -160px; /* Use half of the width to center the tooltip */
        opacity: 0;
        transition: opacity 0.3s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        font-size: 0.875rem;
        line-height: 1.5;
        white-space: pre-wrap; /* Allows for line breaks */
    }
    
    body.dark-mode .tooltip .tooltip-text {
        background-color: #4f4f4f;
    }

    .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }

    /* Container for County Totals tab */
    .county-box {
        border: 1px solid #b2ebf2;
        border-radius: 8px;
        padding: 20px;
        background-color: #f1f8e9;
    }

    body.dark-mode .county-box {
        border-color: #004d40;
        background-color: #252525;
    }

    .county-totals-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        align-items: flex-start;
    }

    .county-table-section,
    .species-by-county-section {
        flex: 1 1 calc(50% - 10px);
        box-sizing: border-box;
        min-width: 350px;
    }

    .county-chase-section {
        min-width: 350px;
        max-width: 600px;
        margin: 0 auto;
        border: 2px solid #ccc;
        border-radius: 8px;
        padding: 0;
        background-color: #fff;
    }

    body.dark-mode .county-chase-section {
        border: 2px solid #444;
        background-color: #1e1e1e;
    }

     .county-chase-item {
        height: 50px;
        display: flex;
        align-items: center;
        padding: 0 15px;
    }

    .county-chase-item:nth-child(odd) {
        background-color: #e8f5e9;
    }

    body.dark-mode .county-chase-item {
        border-bottom: 1px solid #444;
        background-color: #252525;
    }

    body.dark-mode .county-chase-item:nth-child(odd) {
        background-color: #2c2c2c;
    }

    .county-chase-item:hover {
        background-color: #c8e6c9;
        transition: background 0.2s ease;
    }

    body.dark-mode .county-chase-item:hover {
        background-color: #444;
    }

    /* Styles for clickable/selected table rows */
    #resultTable tbody tr, #bigYearTable tbody tr, #monthlyTable tbody tr {
        cursor: pointer;
    }
    #resultTable tbody tr.selected,
    #resultTable tbody tr.selected:hover,
    #bigYearTable tbody tr.selected,
    #bigYearTable tbody tr.selected:hover,
    #monthlyTable tbody tr.selected,
    #monthlyTable tbody tr.selected:hover {
        background-color: #a5d6a7 !important;
        font-weight: bold;
        color: #004d40;
    }
    body.dark-mode #resultTable tbody tr.selected,
    body.dark-mode #resultTable tbody tr.selected:hover,
    body.dark-mode #bigYearTable tbody tr.selected,
    body.dark-mode #bigYearTable tbody tr.selected:hover,
    body.dark-mode #monthlyTable tbody tr.selected,
    body.dark-mode #monthlyTable tbody tr.selected:hover {
        background-color: #005a4e !important;
        color: #e0e0e0;
    }

    /* Two-column layout for interactive total tabs */
    .totals-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        align-items: flex-start;
    }
    .table-section, .species-list-section {
        flex: 1 1 calc(50% - 10px);
        box-sizing: border-box;
        min-width: 350px;
    }
    .species-list-section {
        border: 1px solid #b2ebf2;
        border-radius: 8px;
        padding: 20px;
        background-color: #f1f8e9;
    }
    body.dark-mode .species-list-section {
        border-color: #004d40;
        background-color: #252525;
    }

    .controls-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
    }
    .button-group {
        display: flex;
        gap: 8px;
    }

    /* Remove list markers */
    #countySpeciesList, #speciesList, #monthSpeciesList {
        list-style-type: none;
        padding-left: 0;
        margin-top: 10px;
        columns: 3;
        overflow-y: auto;
        border: 1px solid #eee;
        padding: 10px;
        border-radius: 5px;
        background: #fff;
    }
    #countySpeciesList { max-height: 550px; }
    #speciesList { max-height: 500px; }
    #monthSpeciesList { max-height: 500px; }

    body.dark-mode #countySpeciesList,
    body.dark-mode #speciesList,
    body.dark-mode #monthSpeciesList {
        background-color: #1a1a1a;
        border-color: #333;
    }
    
    /* Loader styles */
    .loader {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #00796b;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    body.dark-mode .loader {
        border: 8px solid #444;
        border-top: 8px solid #80cbc4;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

  </style>
</head>
<body>

  <h2>üê¶ Michigan eBird Summary Program</h2>

  <div class="tabs">
    <div class="tab active" data-tab="upload">Upload</div>
    <div class="tab" data-tab="table">County Totals</div>
	<div class="tab" data-tab="countyChase">Seen All Counties</div>
    <div class="tab" data-tab="monthly">Monthly Totals</div>
    <div class="tab" data-tab="bigyear">Year Totals</div>
    <div class="tab" data-tab="bigmonth">Month Totals by Year</div>
	<div class="tab" data-tab="life">Regional Life/Ticks</div>
    <div class="tab" data-tab="monthNeeds">Month Needs</div>
  </div>

  <div id="upload" class="tab-content active">
    <input type="file" id="csvFile" accept=".csv,.zip">
    <button id="themeToggle" style="margin-left: 15px;">Switch to Dark Mode</button>
    <div id="loader" class="loader" style="display: none; margin-top: 25px;"></div>
    <p><a href="https://ebird.org/downloadMyData" target="_blank">Download your eBird data</a> by logging into your eBird account. The link should take you to the Download page.
	Click the Submit button. You will get an email with a link. Click the link in the email and the data will be downloaded to your computer.  Navigate to the downloaded zip file and select it. 
	The program should only take a second or two to run. Navigate through the tabs to see your processed Michigan data.</p>	
	
	<p> Version 1.0</p>
	<p> Last updated August 15, 2025<p>
    <p><a href="Readme.html" target="_blank">Click here for more information</a></p>
</div>

  <div id="table" class="tab-content">
    <div class="county-totals-container">
	 <div id="summaryBox" style="font-weight: bold; margin-bottom: 15px; flex-basis: 100%;"></div>
	 
        <div class="county-table-section county-box">
		<h3 style="text-align: center; color: #00796b; margin-bottom: 20px;">County Totals</h3>
        <p><b>*Click a county to see its species list.     *Sort by clicking a heading.</b></p>
        <table id="resultTable">
              <thead>
                <tr>
                  <th data-key="county">County</th>
                  <th data-key="count">Total</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
        </div>
        <div class="species-by-county-section county-box">
            <h3 style="text-align: center; color: #00796b; margin-bottom: 20px;">County Species</h3>
            <div class="controls-container">
                <span id="countySpeciesCount" style="font-weight: bold;"></span>
                <div class="button-group">
                    <button id="countySortToggle">Sort: A ‚Üí Z</button>
                    <button id="countyExportCsv">Export CSV</button>
                </div>
            </div>
            <ul id="countySpeciesList"></ul>
        </div>
   </div>
  </div>
  
  <div id="countyChase" class="tab-content">
      <div class="county-chase-section">
        <h3 style="text-align: center; color: #00796b; margin: 20px 0;">Seen All Counties</h3>
		<p style="text-align: center; margin: 0 15px 15px;"><b>***Hover over number to see missing counties for a species</b></p>
        <div id="countyChaseContent"></div>
    </div>
  </div>

  <div id="monthly" class="tab-content">
    <div class="totals-container">
        <div class="table-section">
            <h3 style="text-align: center; color: #00796b; margin-bottom: 20px;">Month Totals</h3>
            <table id="monthlyTable">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="species-list-section">
            <h3 style="text-align: center; color: #00796b; margin-bottom: 20px;">Species for Month</h3>
            <div class="controls-container">
                <span id="monthSpeciesCount" style="font-weight: bold;"></span>
                <div class="button-group">
                    <button id="monthSortToggle">Sort: A ‚Üí Z</button>
                    <button id="monthExportCsv">Export CSV</button>
                </div>
            </div>
            <ul id="monthSpeciesList"></ul>
        </div>
    </div>
  </div>

  <div id="bigyear" class="tab-content">
    <div class="totals-container">
        <div class="table-section">
            <h3 style="text-align: center; color: #00796b; margin-bottom: 20px;">Year Totals</h3>
            <p><b>***Click a year to see its species list</b></p>
            <table id="bigYearTable">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="species-list-section">
            <h3 style="text-align: center; color: #00796b; margin-bottom: 20px;">Species for Year</h3>
            <div class="controls-container">
                <span id="yearSpeciesCount" style="font-weight: bold;"></span>
                <div class="button-group">
                    <button id="sortToggle">Sort: A ‚Üí Z</button>
                    <button id="yearExportCsv">Export CSV</button>
                </div>
            </div>
            <ul id="speciesList"></ul>
        </div>
    </div>
  </div>
  
<div id="life" class="tab-content">
  <h3 style="text-align: center; color: #00796b; margin-bottom: 20px;">Regional Summary</h3>
<table class="life-summary-table">
 <thead>
  <tr>
    <th>Region</th>
    <th>Species Count</th>
    <th>Total Ticks</th>
  </tr>
</thead>

  <tbody>
    <tr><td>Lower Peninsula</td><td id="lowerPeninsulaCount"></td><td id="lowerPeninsulaTicks"></td></tr>
    <tr><td>Upper Peninsula</td><td id="upperPeninsulaCount"></td><td id="upperPeninsulaTicks"></td></tr>
    <tr><td>Saginaw Bay (Arenac, Bay, Huron Iosco, Midland, Saginaw and Tuscola) </td><td id="saginawBayCount"></td><td id="saginawBayTicks"></td></tr>
    <tr><td>Detroit Metro (Wayne, Oakland, Macomb)</td><td id="detroitMetroCount"></td><td id="detroitMetroTicks"></td></tr>
    <tr><td>Capitol Area (Clinton, Eaton, Ingham)</td><td id="capitolAreaCount"></td><td id="capitolAreaTicks"></td></tr>
    <tr><td>Northern Lower Peninsula (Oceana to Bay & North)</td><td id="northernLowerPeninsulaCount"></td><td id="northernLowerPeninsulaTicks"></td></tr>
    <tr><td>Southern Lower Peninsula (Muskegon to Saginaw & South)</td><td id="southernLowerPeninsulaCount"></td><td id="southernLowerPeninsulaTicks"></td></tr>
	<tr><td>Keweenaw Peninsula (Keweenaw, Houghton, Baraga)</td><td id="keweenawPeninsulaCount"></td><td id="keweenawPeninsulaTicks"></td></tr>
	<tr><td>Huron-Clinton Metroparks Authority (HCMA)</td><td id="hcmaMetroparksCount"></td><td>-</td></tr>
  </tbody>
</table>

</div>


<div id="bigmonth" class="tab-content">
  <table id="bigMonthTable">
    <thead>
      <tr>
        <th>Year</th>
	<th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th>
	<th>May</th><th>Jun</th><th>Jul</th><th>Aug</th>
	<th>Sep</th><th>Oct</th><th>Nov</th><th>Dec</th>
	<th>Total</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="monthNeeds" class="tab-content">
  <div id="totalMonthsSpeciesCount"></div>
  <div class="month-needs-container">
    <div class="month-needs-section">
      <h3>Species Not Seen in Selected Month</h3>
      <label for="monthNeedsMonthSelector">Select Month:</label>
      <select id="monthNeedsMonthSelector"></select>
      <ul id="monthNeedsSpeciesMissingList"></ul>
    </div>
    <div class="month-needs-section">
      <h3>Months Seen / Not Seen for a Species</h3>
      <label for="monthNeedsSpeciesSelector">Select Species:</label>
      <select id="monthNeedsSpeciesSelector"></select>
      <h4>Months Seen:</h4>
      <ul id="monthNeedsSpeciesSeenList"></ul>
      <h4>Months Not Seen:</h4>
      <ul id="monthNeedsSpeciesNotSeenList"></ul>
    </div>
  </div>
</div>
<script>
    // Tab Switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

  document.getElementById('csvFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  document.getElementById('loader').style.display = 'block'; // Show loader

  // Use a timeout to allow the UI to update and show the loader before processing
  setTimeout(() => {
    if (file.name.endsWith('.zip')) {
      const zipReader = new FileReader();
      zipReader.onload = function(evt) {
        JSZip.loadAsync(evt.target.result).then(zip => {
          const csvFileName = Object.keys(zip.files).find(name => name.toLowerCase().endsWith("myebirddata.csv"));
          if (!csvFileName) {
            showMessageBox("MyEBirdData.csv not found in ZIP file.");
            document.getElementById('loader').style.display = 'none'; // Hide loader on error
            return;
          }
          zip.files[csvFileName].async("string").then(csvText => {
            parseCsv(csvText);
          });
        });
      };
      zipReader.readAsArrayBuffer(file);
    } else {
      const reader = new FileReader();
      reader.onload = function(event) {
        parseCsv(event.target.result);
      };
      reader.readAsText(file);
    }
  }, 10); // A short delay is enough
});


    let currentData = [];
    // Data structures for various tabs
    let allUniqueSpecies = new Set();
    let speciesByMonth = new Map();
    let monthsBySpecies = new Map();
    let yearMap = {};
    let monthlyMap = Array.from({ length: 12 }, () => new Set());


	let lowerTicks = 0, upperTicks = 0, northernLowerTicks = 0, southernLowerTicks = 0;
    let saginawTicks = 0, detroitTicks = 0, capitolTicks = 0, keweenawTicks = 0;
	let speciesSortMode = "taxo"; // "alpha" or "taxo"
	let taxonomicOrderMap = {};
    let countyMap = {};

    // State variables for selected items
    let currentCountyForList = '';
    let currentSelectedYear = '';
    let currentSelectedMonth = { index: -1, name: '' };


  // Custom message box instead of alert
  function showMessageBox(message) {
    const messageBox = document.createElement('div');
    messageBox.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 1000;
      border-radius: 8px;
      text-align: center;
      font-family: sans-serif;
      color: #333;
    `;
    messageBox.innerHTML = `
      <p>${message}</p>
      <button style="margin-top: 15px; padding: 10px 20px; border: none; background-color: #00796b; color: white; border-radius: 5px; cursor: pointer;">OK</button>
    `;
    document.body.appendChild(messageBox);

    messageBox.querySelector('button').addEventListener('click', () => {
      document.body.removeChild(messageBox);
    });
  }
  
 function parseDateStrict(dateStr) {
  if (!dateStr || typeof dateStr !== "string") return NaN;

  if (dateStr === "1/1/1900" || dateStr === "1900-01-01") {
    return new Date(Date.UTC(1900, 0, 1));
  }

  let date;

  if (dateStr.includes('/')) {
    const [month, day, year] = dateStr.split('/').map(Number);
    if (!month || !day || !year) return NaN;
    date = new Date(Date.UTC(year, month - 1, day));
    if (
      date.getUTCFullYear() !== year ||
      date.getUTCMonth() !== (month - 1) ||
      date.getUTCDate() !== day
    ) return NaN;
  }
  else if (dateStr.includes('-')) {
    date = new Date(dateStr + 'T00:00:00Z');
    if (isNaN(date)) return NaN;
  }

  return date;
}

    function renderTable(data) {
      const tbody = document.querySelector('#resultTable tbody');
      tbody.innerHTML = '';
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.county}</td><td>${row.count}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderSummary(data) {
      const grandTotal = data.reduce((acc, row) => acc + row.count, 0);
      const thresholds = [300, 250, 200, 150, 100];
      const counts = thresholds.map(thresh => {
        return `Counties ‚â• ${thresh}: ${data.filter(row => row.count >= thresh).length}`;
      });
      document.getElementById('summaryBox').innerHTML =
        `Total County Ticks: ${grandTotal} | ${counts.join(" | ")}`;
    }

    function renderMonthlyTable(data) {
      monthlyMap = Array.from({ length: 12 }, () => new Set());
      data.forEach(row => {
        const date = parseDateStrict(row["Date"]);
        const common = row["Common Name"];
        if (!isNaN(date) && !(date.getUTCFullYear() === 1900) && common) {
            monthlyMap[date.getUTCMonth()].add(common);
        }
      });

      const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      const result = months.map((month, i) => ({ month, count: monthlyMap[i].size }));

      const tbody = document.querySelector('#monthlyTable tbody');
      tbody.innerHTML = '';
      result.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.dataset.monthIndex = index;
        tr.dataset.monthName = row.month;
        tr.innerHTML = `<td>${row.month}</td><td>${row.count}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderBigYearTable(data) {
      yearMap = {};
      data.forEach(row => {
        const date = parseDateStrict(row["Date"]);
        const year = date.getUTCFullYear();
        const common = row["Common Name"];
        if (!isNaN(year) && common) {
          if (!yearMap[year]) yearMap[year] = new Set();
          yearMap[year].add(common);
        }
      });

      let bigYearData = Object.keys(yearMap).map(year => ({ year, count: yearMap[year].size }));

      const sortHandler = (key, isAsc) => {
          bigYearData.sort((a, b) => {
              const valA = key === 'year' ? parseInt(a.year) : a.count;
              const valB = key === 'year' ? parseInt(b.year) : b.count;
              return isAsc ? valA - valB : valB - valA;
          });
          renderBigYearTableBody(bigYearData);
      };

      const ths = document.querySelectorAll('#bigYearTable th');
      ths.forEach(th => {
          th.addEventListener('click', () => {
              const key = th.innerText.includes("Year") ? "year" : "count";
              const isAsc = !th.classList.contains('sort-asc');
              ths.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
              th.classList.toggle('sort-asc', isAsc);
              th.classList.toggle('sort-desc', !isAsc);
              sortHandler(key, isAsc);
          });
      });
      
      // Initial sort
      ths[0].classList.add('sort-desc');
      sortHandler('year', false);
    }

    function renderBigYearTableBody(data) {
      const tbody = document.querySelector('#bigYearTable tbody');
      tbody.innerHTML = '';
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.year}</td><td>${row.count}</td>`;
        tbody.appendChild(tr);
      });
    }

    document.querySelectorAll('#resultTable th').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.dataset.key;
        const isAsc = !th.classList.contains('sort-asc');

        document.querySelectorAll('#resultTable th').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
        th.classList.add(isAsc ? 'sort-asc' : 'sort-desc');

        const sorted = [...currentData].sort((a, b) => {
          if (key === 'count') return isAsc ? a.count - b.count : b.count - a.count;
          return isAsc ? a.county.localeCompare(b.county) : b.county.localeCompare(a.county);
        });

        renderTable(sorted);
      });
    });

function renderBigMonthTable(data) {
  const monthMap = {}; 

  data.forEach(row => {
    const date = parseDateStrict(row["Date"]);
    const month = date.getUTCMonth(); 
    const year = date.getUTCFullYear(); 
    const species = row["Common Name"];

    if (!isNaN(year) && !isNaN(month) && species && !(year === 1900)) {
      if (!monthMap[year]) {
        monthMap[year] = Array.from({ length: 12 }, () => new Set());
      }
      monthMap[year][month].add(species);
    }
  });

 const sortedYears = Object.keys(monthMap).map(Number).sort((a, b) => b - a);
  const tbody = document.querySelector('#bigMonthTable tbody');
  tbody.innerHTML = '';

  sortedYears.forEach(year => {
    const monthSets = monthMap[year];
    const counts = monthSets.map(set => set.size);
    const total = counts.reduce((sum, val) => sum + val, 0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${year}</td>` + counts.map(c => `<td>${c}</td>`).join('') + `<td>${total}</td>`;

    tbody.appendChild(tr);
  });
}

function renderLifeTab(data) {
  const lowerPeninsulaCounties = new Set([
    "Alcona", "Allegan", "Alpena", "Antrim", "Arenac", "Barry", "Bay", "Benzie", "Berrien",
    "Branch", "Calhoun", "Cass", "Charlevoix", "Cheboygan", "Clare", "Clinton", "Crawford",
    "Eaton", "Emmet", "Genesee", "Gladwin", "Grand Traverse", "Gratiot", "Hillsdale", "Huron",
    "Ingham", "Ionia", "Iosco", "Isabella", "Jackson", "Kalamazoo", "Kalkaska", "Kent", "Lake",
    "Lapeer", "Leelanau", "Lenawee", "Livingston", "Macomb", "Manistee", "Mason", "Mecosta",
    "Midland", "Missaukee", "Monroe", "Montcalm", "Montmorency", "Muskegon", "Newaygo",
    "Oakland", "Oceana", "Ogemaw", "Osceola", "Oscoda", "Otsego", "Ottawa", "Presque Isle",
    "Roscommon", "Saginaw", "Sanilac", "Shiawassee", "St. Clair", "St. Joseph", "Tuscola",
    "Van Buren", "Washtenaw", "Wayne", "Wexford"
  ]);
    
  const northernLowerPeninsulaCounties = new Set([
    "Alcona", "Alpena", "Antrim", "Arenac", "Bay", "Benzie", 
    "Charlevoix", "Cheboygan", "Clare", "Crawford", "Emmet", 
    "Gladwin", "Grand Traverse", "Iosco", "Isabella", 
    "Kalkaska", "Lake", "Leelanau", "Manistee", "Mason", 
    "Mecosta", "Midland", "Missaukee", "Montmorency", "Newaygo", 
    "Oceana", "Ogemaw", "Osceola", "Oscoda", "Otsego", 
    "Presque Isle", "Roscommon", "Wexford"
]);

const southernLowerPeninsulaCounties = new Set([
  "Allegan", "Barry", "Berrien", "Branch", "Calhoun", "Cass", "Clinton", "Eaton", "Genesee",
  "Gratiot", "Hillsdale", "Huron", "Ingham", "Ionia", "Jackson", "Kalamazoo", "Lapeer", "Kent", 
  "Lenawee", "Livingston", "Macomb", "Monroe", "Montcalm", "Muskegon", "Oakland", "Ottawa",
  "Saginaw", "Sanilac", "Shiawassee", "St. Clair", "St. Joseph", "Tuscola", "Van Buren",
  "Washtenaw", "Wayne"
]);

const keweenawPeninsulaCounties = new Set([
  "Keweenaw", "Baraga", "Houghton"
]);

  const upperPeninsulaCounties = new Set([
    "Alger", "Baraga", "Chippewa", "Delta", "Dickinson", "Gogebic", "Houghton",
    "Iron", "Keweenaw", "Luce", "Mackinac", "Marquette", "Menominee", "Ontonagon", "Schoolcraft"
  ]);

  const saginawBayCounties = new Set([
    "Arenac", "Bay", "Huron", "Iosco", "Midland", "Saginaw", "Tuscola"
  ]);

  const detroitMetroCounties = new Set([
    "Wayne", "Oakland", "Macomb"
  ]);

  const capitolAreaCounties = new Set([
    "Clinton", "Eaton", "Ingham"
  ]);

  const hcmaLocations = new Set([
    "Delhi Metropark",
    "Dexter Huron Metropark",
    "Hudson Mills Metropark",
    "Huron Meadows Metropark",
    "Indian Springs Metropark",
    "Indian Springs Metropark--Biking and Hiking Trail",
    "Kensington Metropark--Livingston Co. only",
    "Kensington Metropark--general (Oakland Co. only)",
    "Kensington Metropark--Dawson Rd. bridge",
    "Kensington Metropark--Group Camp",
	"Kensington Metropark--Farm Center",
    "Lake Erie Metropark",
    "Lake Erie Metropark--Detroit River Hawk Watch",
    "Lake St. Clair Metropark (Metro Beach Metropark)",
    "Lower Huron Metropark",
    "Oakwoods Metropark",
    "Stony Creek Metropark (Oakland Co.)",
    "Stony Creek Metropark--Inwood Trails",
    "Stony Creek Metropark--north (Macomb Co.)",
    "Stony Creek Metropark--south (Macomb Co.)",
    "Willow Metropark",
    "Wolcott Mill Metropark",
    "Wolcott Mill Metropark--North Branch Trails",
	"Wolcott Mill Metropark--Camp Rotary",
    "Wolcott Mill Metropark--north trails"
  ]);

  const lowerSet = new Set();
  const upperSet = new Set();
  const northernLowerSet = new Set();
  const southernLowerSet = new Set();
  const saginawSet = new Set();
  const detroitSet = new Set();
  const capitolSet = new Set();
  const keweenawSet = new Set();
  const hcmaSet = new Set();

  const countySpeciesMap = {};
  data.forEach(row => {
    const county = row["County"];
    const name = row["Common Name"];
    if (!county || !name) return;

    if (!countySpeciesMap[county]) {
      countySpeciesMap[county] = new Set();
    }
    countySpeciesMap[county].add(name);
  });

  function sumRegionTicks(regionSet) {
    let total = 0;
    regionSet.forEach(county => {
      if (countySpeciesMap[county]) {
        total += countySpeciesMap[county].size;
      }
    });
    return total;
  }

  const lowerTicks = sumRegionTicks(lowerPeninsulaCounties);
  const upperTicks = sumRegionTicks(upperPeninsulaCounties);
  const northernLowerTicks = sumRegionTicks(northernLowerPeninsulaCounties);
  const southernLowerTicks = sumRegionTicks(southernLowerPeninsulaCounties);
  const saginawTicks = sumRegionTicks(saginawBayCounties);
  const detroitTicks = sumRegionTicks(detroitMetroCounties);
  const capitolTicks = sumRegionTicks(capitolAreaCounties);
  const keweenawTicks = sumRegionTicks(keweenawPeninsulaCounties);

  data.forEach(row => {
    const county = row["County"];
    const name = row["Common Name"];
    const location = row["Location"];

    if (!name) return;

    if (lowerPeninsulaCounties.has(county)) lowerSet.add(name);
    if (upperPeninsulaCounties.has(county)) upperSet.add(name);
	if (northernLowerPeninsulaCounties.has(county)) northernLowerSet.add(name);
	if (southernLowerPeninsulaCounties.has(county)) southernLowerSet.add(name);
    if (saginawBayCounties.has(county)) saginawSet.add(name);
    if (detroitMetroCounties.has(county)) detroitSet.add(name);
    if (capitolAreaCounties.has(county)) capitolSet.add(name);
	if (keweenawPeninsulaCounties.has(county)) keweenawSet.add(name);
    if (location && hcmaLocations.has(location)) {
        hcmaSet.add(name);
    }
  });

document.getElementById("hcmaMetroparksCount").innerText = hcmaSet.size.toLocaleString();
document.getElementById("lowerPeninsulaCount").innerText = lowerSet.size.toLocaleString();
document.getElementById("upperPeninsulaCount").innerText = upperSet.size.toLocaleString();
document.getElementById("northernLowerPeninsulaCount").innerText = northernLowerSet.size.toLocaleString();
document.getElementById("southernLowerPeninsulaCount").innerText = southernLowerSet.size.toLocaleString();
document.getElementById("saginawBayCount").innerText = saginawSet.size.toLocaleString();
document.getElementById("detroitMetroCount").innerText = detroitSet.size.toLocaleString();
document.getElementById("capitolAreaCount").innerText = capitolSet.size.toLocaleString();
document.getElementById("keweenawPeninsulaCount").innerText = keweenawSet.size.toLocaleString();
document.getElementById("lowerPeninsulaTicks").innerText = lowerTicks.toLocaleString();
document.getElementById("upperPeninsulaTicks").innerText = upperTicks.toLocaleString();
document.getElementById("northernLowerPeninsulaTicks").innerText = northernLowerTicks.toLocaleString();
document.getElementById("southernLowerPeninsulaTicks").innerText = southernLowerTicks.toLocaleString();
document.getElementById("saginawBayTicks").innerText = saginawTicks.toLocaleString();
document.getElementById("detroitMetroTicks").innerText = detroitTicks.toLocaleString();
document.getElementById("capitolAreaTicks").innerText = capitolTicks.toLocaleString();
document.getElementById("keweenawPeninsulaTicks").innerText = keweenawTicks.toLocaleString();

}

function setupSpeciesByCounty(data) {
    countyMap = {};
    data.forEach(row => {
        const name = row["Common Name"];
        const county = row["County"];
        if (!county || !name) return;
        if (!countyMap[county]) countyMap[county] = new Set();
        countyMap[county].add(name);
    });
}

function updateCountySpeciesList(county) {
    currentCountyForList = county;
    const list = document.getElementById("countySpeciesList");
    const countSpan = document.getElementById("countySpeciesCount");
    const species = Array.from(countyMap[county] || []);

    species.sort((a, b) => {
        if (speciesSortMode === "alpha") return a.localeCompare(b);
        const rankA = taxonomicOrderMap[a] ?? 9999;
        const rankB = taxonomicOrderMap[b] ?? 9999;
        return rankA - rankB || a.localeCompare(b);
    });

    countSpan.innerHTML = `<strong>${county}</strong> &ndash; Species: ${species.length}`;
    list.innerHTML = '';
    species.forEach(name => {
        const li = document.createElement('li');
        li.textContent = name;
        list.appendChild(li);
    });

    document.querySelectorAll('#resultTable tbody tr').forEach(row => {
        row.classList.toggle('selected', row.cells[0].textContent === county);
    });
}

function updateYearSpeciesList(year) {
    currentSelectedYear = year;
    const list = document.getElementById("speciesList");
    const countSpan = document.getElementById("yearSpeciesCount");
    const species = Array.from(yearMap[year] || []);

    species.sort((a, b) => {
        if (speciesSortMode === "alpha") return a.localeCompare(b);
        const rankA = taxonomicOrderMap[a] ?? 9999;
        const rankB = taxonomicOrderMap[b] ?? 9999;
        return rankA - rankB || a.localeCompare(b);
    });

    countSpan.innerHTML = `<strong>${year}</strong> &ndash; Species: ${species.length}`;
    list.innerHTML = '';
    species.forEach(name => {
        const li = document.createElement('li');
        li.textContent = name;
        list.appendChild(li);
    });

    document.querySelectorAll('#bigYearTable tbody tr').forEach(row => {
        row.classList.toggle('selected', row.cells[0].textContent === year);
    });
}

function updateMonthSpeciesList(monthIndex, monthName) {
    currentSelectedMonth = { index: monthIndex, name: monthName };
    const list = document.getElementById("monthSpeciesList");
    const countSpan = document.getElementById("monthSpeciesCount");
    const species = Array.from(monthlyMap[monthIndex] || []);
    
    species.sort((a, b) => {
        if (speciesSortMode === "alpha") return a.localeCompare(b);
        const rankA = taxonomicOrderMap[a] ?? 9999;
        const rankB = taxonomicOrderMap[b] ?? 9999;
        return rankA - rankB || a.localeCompare(b);
    });

    countSpan.innerHTML = `<strong>${monthName}</strong> &ndash; Species: ${species.length}`;
    list.innerHTML = '';
    species.forEach(name => {
        const li = document.createElement('li');
        li.textContent = name;
        list.appendChild(li);
    });

    document.querySelectorAll('#monthlyTable tbody tr').forEach(row => {
        row.classList.toggle('selected', parseInt(row.dataset.monthIndex) === monthIndex);
    });
}

function exportToCsv(filename, headers, data) {
    const csvContent = "data:text/csv;charset=utf-8," 
        + [headers.join(","), ...data.map(row => row.join(","))].join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function initializeClickListeners() {
    // Table row clicks
    document.querySelector('#resultTable tbody').addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        if (row) updateCountySpeciesList(row.cells[0].textContent);
    });
    
    document.querySelector('#bigYearTable tbody').addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        if (row) updateYearSpeciesList(row.cells[0].textContent);
    });

    document.querySelector('#monthlyTable tbody').addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        if (row) updateMonthSpeciesList(parseInt(row.dataset.monthIndex), row.dataset.monthName);
    });

    // Sort button clicks
    document.getElementById('countySortToggle').addEventListener('click', function () {
        speciesSortMode = speciesSortMode === "alpha" ? "taxo" : "alpha";
        this.textContent = `Sort: ${speciesSortMode === "alpha" ? "Taxonomic" : "A ‚Üí Z"}`;
        if (currentCountyForList) updateCountySpeciesList(currentCountyForList);
    });

    document.getElementById('sortToggle').addEventListener('click', () => {
        speciesSortMode = speciesSortMode === "alpha" ? "taxo" : "alpha";
        document.getElementById('sortToggle').textContent = `Sort: ${speciesSortMode === "alpha" ? "Taxonomic" : "A ‚Üí Z"}`;
        if (currentSelectedYear) updateYearSpeciesList(currentSelectedYear);
    });

    document.getElementById('monthSortToggle').addEventListener('click', () => {
        speciesSortMode = speciesSortMode === "alpha" ? "taxo" : "alpha";
        document.getElementById('monthSortToggle').textContent = `Sort: ${speciesSortMode === "alpha" ? "Taxonomic" : "A ‚Üí Z"}`;
        if (currentSelectedMonth.index !== -1) updateMonthSpeciesList(currentSelectedMonth.index, currentSelectedMonth.name);
    });
    
    // Export/Print button listeners
    const setupExportButtons = (type) => {
        const listId = type === 'county' ? 'countySpeciesList' : type === 'month' ? 'monthSpeciesList' : 'speciesList';
        const contextId = type === 'county' ? 'countySpeciesCount' : type === 'month' ? 'monthSpeciesCount' : 'yearSpeciesCount';

        document.getElementById(`${type}ExportCsv`).addEventListener('click', () => {
            const list = document.getElementById(listId);
            const items = Array.from(list.querySelectorAll('li')).map(li => [li.textContent]);
            if (items.length === 0) { showMessageBox("No species to export."); return; }
            
            const contextText = document.getElementById(contextId).querySelector('strong').textContent;
            const filename = `MI-eBird-${contextText.replace(' ', '-')}-Species.csv`;
            exportToCsv(filename, ['Species'], items);
        });
    };

    setupExportButtons('county');
    setupExportButtons('month');
    setupExportButtons('year');
}


// List of all 83 Michigan counties for the County Chase tab
const allMichiganCounties = new Set([
    "Alcona", "Alger", "Allegan", "Alpena", "Antrim", "Arenac", "Baraga", "Barry", "Bay", "Benzie", "Berrien", "Branch", "Calhoun", "Cass", "Charlevoix", "Cheboygan", "Chippewa", "Clare", "Clinton", "Crawford", "Delta", "Dickinson", "Eaton", "Emmet", "Genesee", "Gladwin", "Gogebic", "Grand Traverse", "Gratiot", "Hillsdale", "Houghton", "Huron", "Ingham", "Ionia", "Iosco", "Iron", "Isabella", "Jackson", "Kalamazoo", "Kalkaska", "Kent", "Keweenaw", "Lake", "Lapeer", "Leelanau", "Lenawee", "Livingston", "Luce", "Mackinac", "Macomb", "Manistee", "Marquette", "Mason", "Mecosta", "Menominee", "Midland", "Missaukee", "Monroe", "Montcalm", "Montmorency", "Muskegon", "Newaygo", "Oakland", "Oceana", "Ogemaw", "Ontonagon", "Osceola", "Oscoda", "Otsego", "Ottawa", "Presque Isle", "Roscommon", "Saginaw", "St. Clair", "St. Joseph", "Sanilac", "Schoolcraft", "Shiawassee", "Tuscola", "Van Buren", "Washtenaw", "Wayne", "Wexford"
]);

function renderCountyChaseResults(data) {
    const speciesToCountyMap = new Map();

    data.forEach(row => {
        const species = row['Common Name'];
        const county = row['County'];
        if (species && county) {
            if (!speciesToCountyMap.has(species)) {
                speciesToCountyMap.set(species, new Set());
            }
            speciesToCountyMap.get(species).add(county);
        }
    });

    const countyCountToSpeciesMap = new Map();
    for (let i = 1; i <= 83; i++) countyCountToSpeciesMap.set(i, []);

    speciesToCountyMap.forEach((counties, species) => {
        countyCountToSpeciesMap.get(counties.size).push({ species, seenCounties: counties });
    });

    const resultsContent = document.getElementById('countyChaseContent');
    resultsContent.innerHTML = '';
    let cumulativeCount = 0;

    for (let i = 83; i >= 1; i--) {
        const speciesList = countyCountToSpeciesMap.get(i) || [];
        if (speciesList.length > 0) {
            cumulativeCount += speciesList.length;

            const tooltipContent = speciesList.map(item => {
                const missingCounties = [...allMichiganCounties].filter(c => !item.seenCounties.has(c));
                return missingCounties.length === 0 ? `${item.species} (Seen in all counties)` : `${item.species} (Missing: ${missingCounties.join(', ')})`;
            }).join('\n');

            const resultDiv = document.createElement('div');
            resultDiv.className = 'county-chase-item';
            resultDiv.innerHTML = `
                <p style="font-size: 1.1em;">
                    <span class="tooltip">
                        <span style="font-weight: bold; color: ${i === 83 ? '#4caf50' : '#00796b'};">${cumulativeCount}</span>
                        <span class="tooltip-text">${tooltipContent}</span>
                    </span>
                    species seen in <span style="font-weight: 600;">${i}</span> counties.
                </p>`;
            resultsContent.appendChild(resultDiv);
        }
    }
}



function parseCsv(text) {
  const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
  const data = parsed.data;

  taxonomicOrderMap = {};
  let taxoIndex = 0;
  data.forEach(row => {
    const name = row["Common Name"];
    if (name && !(name in taxonomicOrderMap)) {
      taxonomicOrderMap[name] = taxoIndex++;
    }
  });

  const speciesToFilterOut = new Set([
    "Graylag Goose", "Swan Goose", "Ruddy Shelduck", "Muscovy Duck", "White-checked Pintail", 
    "Indian Peafowl", "Red Junglefowl", "Helmeted Guineafowl", "Lesser Rhea", "Chukar", "Budgerigar",
    "African Collared-Dove", "European Goldfinch", "Whooping Crane"
  ]);

  const filtered = data.filter(row => {
    const state = row["State/Province"];
    let common = row["Common Name"];
    if (state !== "US-MI" || !common || speciesToFilterOut.has(common)) return false;
    
    if (common === "Northern Bobwhite") {
        const date = parseDateStrict(row["Date"]);
        if (!isNaN(date) && date >= new Date(Date.UTC(2020, 0, 1))) return false;
    }

    if (common.includes("(") && common.includes(")")) {
      const match = common.match(/\(([^)]+)\)/);
      if (match && (match[1].toLowerCase().includes("hybrid") || match[1].toLowerCase().includes("domestic"))) return false;
      row["Common Name"] = common.replace(/\s*\([^)]*\)/g, '').trim();
      common = row["Common Name"];
    }

    return !common.includes("/") && !common.includes("sp.");
  });

  allUniqueSpecies.clear();
  speciesByMonth.clear();
  monthsBySpecies.clear();
  filtered.forEach(row => {
    const date = parseDateStrict(row["Date"]);
    const speciesName = row["Common Name"];
    if (!isNaN(date) && speciesName && !(date.getUTCFullYear() === 1900)) {
      allUniqueSpecies.add(speciesName);
      const monthIndex = date.getUTCMonth();
      if (!speciesByMonth.has(monthIndex)) speciesByMonth.set(monthIndex, new Set());
      speciesByMonth.get(monthIndex).add(speciesName);
      if (!monthsBySpecies.has(speciesName)) monthsBySpecies.set(speciesName, new Set());
      monthsBySpecies.get(speciesName).add(monthIndex);
    }
  });

  const countySet = new Set();
  filtered.forEach(row => { if (row["County"]) countySet.add(row["County"]); });
  currentData = Array.from(countySet).map(county => ({ county, count: new Set(filtered.filter(r => r["County"] === county).map(r => r["Common Name"])).size }));

  renderTable(currentData);
  renderSummary(currentData);
  renderMonthlyTable(filtered);
  renderBigYearTable(filtered);
  renderBigMonthTable(filtered);
  renderLifeTab(filtered);
  setupSpeciesByCounty(filtered);
  initializeClickListeners();
  renderMonthNeedsTab();
  renderCountyChaseResults(filtered); 

  // Set initial states
  document.querySelector('#resultTable th[data-key="county"]').click();
  const firstCountyRow = document.querySelector('#resultTable tbody tr');
  if (firstCountyRow) updateCountySpeciesList(firstCountyRow.cells[0].textContent);
  
  const firstYearRow = document.querySelector('#bigYearTable tbody tr');
  if (firstYearRow) updateYearSpeciesList(firstYearRow.cells[0].textContent);

  const firstMonthRow = document.querySelector('#monthlyTable tbody tr');
  if (firstMonthRow) updateMonthSpeciesList(parseInt(firstMonthRow.dataset.monthIndex), firstMonthRow.dataset.monthName);
  
  document.querySelector('.tab[data-tab="table"]').click();
  document.getElementById('loader').style.display = 'none'; // Hide loader when done
}

function renderMonthNeedsTab() {
  const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  let speciesSeenInAll12MonthsCount = 0;
  allUniqueSpecies.forEach(s => { if (monthsBySpecies.get(s)?.size === 12) speciesSeenInAll12MonthsCount++; });

  document.getElementById('totalMonthsSpeciesCount').textContent = `Total Species Seen in all 12 Months: ${speciesSeenInAll12MonthsCount}`;
  const monthSelector = document.getElementById('monthNeedsMonthSelector');
  monthSelector.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');

  const speciesMissingList = document.getElementById('monthNeedsSpeciesMissingList');
  function updateSpeciesMissingList() {
    const selectedMonthIndex = parseInt(monthSelector.value);
    const speciesSeenInMonth = speciesByMonth.get(selectedMonthIndex) || new Set();
    const missingSpecies = Array.from(allUniqueSpecies).filter(s => !speciesSeenInMonth.has(s)).sort();
    speciesMissingList.innerHTML = missingSpecies.length ? missingSpecies.map(s => `<li>${s}</li>`).join('') : "<li>All unique species seen in this month!</li>";
  }
  monthSelector.addEventListener('change', updateSpeciesMissingList);

  const speciesSelector = document.getElementById('monthNeedsSpeciesSelector');
  const sortedSpecies = Array.from(allUniqueSpecies).sort();
  speciesSelector.innerHTML = sortedSpecies.map(s => `<option value="${s}">${s}</option>`).join('');
  
  const speciesSeenList = document.getElementById('monthNeedsSpeciesSeenList');
  const speciesNotSeenList = document.getElementById('monthNeedsSpeciesNotSeenList');
  function updateSpeciesMonthCoverage() {
    const seenMonths = monthsBySpecies.get(speciesSelector.value) || new Set();
    let seenHTML = '', notSeenHTML = '';
    months.forEach((m, i) => {
      if (seenMonths.has(i)) seenHTML += `<li>${m}</li>`;
      else notSeenHTML += `<li>${m}</li>`;
    });
    speciesSeenList.innerHTML = seenHTML || '<li>Not seen in any month yet.</li>';
    speciesNotSeenList.innerHTML = notSeenHTML || '<li>Seen in all 12 months!</li>';
  }
  speciesSelector.addEventListener('change', updateSpeciesMonthCoverage);

  if (months.length > 0) updateSpeciesMissingList();
  if (sortedSpecies.length > 0) updateSpeciesMonthCoverage();
}

document.addEventListener('DOMContentLoaded', () => {
  const themeToggleBtn = document.getElementById('themeToggle');
  const body = document.body;
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    body.classList.add('dark-mode');
    themeToggleBtn.textContent = 'Switch to Light Mode';
  } else {
    themeToggleBtn.textContent = 'Switch to Dark Mode';
  }
  themeToggleBtn.addEventListener('click', () => {
    body.classList.toggle('dark-mode');
    const isDark = body.classList.contains('dark-mode');
    themeToggleBtn.textContent = isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode';
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  });
});

  </script>
  
</body>
</html>