<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>eBird Michigan Summary</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üê¶</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js?v=1"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js?v=1"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(to right, #e0f7fa, #e1f5fe);
      color: #333;
    }

    body.dark-mode {
      background: #121212; /* Dark background */
      color: #e0e0e0; /* Light text color */
    }

    h2 {
      text-align: center;
      color: #00796b;
      margin-bottom: 30px;
    }

    body.dark-mode h2 {
      color: #80cbc4;
    }

    .life-summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: #ffffffcc;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }

    body.dark-mode .life-summary-table {
      background: #1e1e1e;
      color: #e0e0e0;
      border-color: #444;
    }

    .life-summary-table th, .life-summary-table td {
      padding: 12px 15px;
      border: 1px solid #ccc;
      text-align: left;
    }

    body.dark-mode .life-summary-table th,
    body.dark-mode .life-summary-table td {
      border-color: #444;
    }

    .life-summary-table th {
      background-color: #00796b;
      color: #fff;
      text-align: center;
    }

    body.dark-mode .life-summary-table th {
      background-color: #004d40;
    }

    .life-summary-table tr:nth-child(even) {
      background-color: #f1f8e9;
    }

    body.dark-mode .life-summary-table tr:nth-child(even) {
      background: #252525;
    }

    .life-summary-table tr:hover {
      background-color: #c8e6c9;
    }

    body.dark-mode .life-summary-table tr:hover {
      background: #444;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 15px;
      gap: 10px;
    }

    body.dark-mode .tabs {
      background: #1e1e1e;
    }

    .tab {
      padding: 10px 20px;
      background: #b2ebf2;
      border-radius: 25px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    body.dark-mode .tab {
      background: #333;
      color: #b3e5fc;
    }

    .tab:hover {
      background: #4dd0e1;
      color: #fff;
    }

    body.dark-mode .tab:hover {
      background: #004d40;
    }

    .tab.active {
      background: #00796b;
      color: #fff;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    body.dark-mode .tab.active {
      background: #00796b;
      color: #fff;
    }

    .tab-content {
      display: none;
      background: #ffffffee;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }

    body.dark-mode .tab-content {
      background: #1e1e1e;
      border: 1px solid #333;
    }

    .tab-content.active {
      display: block;
    }

    input[type="file"] {
      padding: 10px;
      border: 2px dashed #80deea;
      border-radius: 10px;
      background-color: #e0f7fa;
      transition: all 0.3s ease;
    }

    body.dark-mode input[type="file"] {
      background-color: #333;
      color: #fff;
      border-color: #555;
    }

    input[type="file"]:hover {
      background: #b2ebf2;
      cursor: pointer;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      table-layout: auto;
    }

    body.dark-mode table {
      background: #1e1e1e;
      color: #e0e0e0;
      border-color: #444;
    }

    th, td {
      padding: 12px 15px;
      border: 1px solid #ccc;
      text-align: left;
    }

    body.dark-mode th,
    body.dark-mode td {
      border-color: #444;
    }

    th {
      background: #00796b;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 2;
      cursor: pointer;
      user-select: none;
    }

    body.dark-mode th {
      background: #004d40;
    }

    th.sort-asc::after { content: " üîº"; }
    th.sort-desc::after { content: " üîΩ"; }

    tr:nth-child(even) {
      background: #f1f8e9;
    }

    body.dark-mode tr:nth-child(even) {
      background: #252525;
    }

    tr:nth-child(odd) {
      background: #e8f5e9;
    }

    body.dark-mode tr:nth-child(odd) {
      background: #2c2c2c;
    }

    tr:hover {
      background: #c8e6c9;
      transition: background 0.2s ease;
    }

    body.dark-mode tr:hover {
      background: #444;
    }

    #summaryBox {
      font-size: 1.1em;
      margin-bottom: 15px;
      background: #f1f8e9;
      padding: 10px 15px;
      border-left: 5px solid #4caf50;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    body.dark-mode #summaryBox {
      background: #2c2c2c;
      border-left-color: #4caf50;
      color: #e0e0e0;
    }

    body.dark-mode select,
    body.dark-mode button {
      background-color: #333;
      color: #fff;
      border: 1px solid #555;
    }

    body.dark-mode ul#speciesList,
    body.dark-mode ul#countySpeciesList,
    body.dark-mode ul#monthNeedsSpeciesMissingList,
    body.dark-mode ul#monthNeedsSpeciesSeenList,
    body.dark-mode ul#monthNeedsSpeciesNotSeenList {
      color: #e0e0e0;
    }

    /* Styles for the new Month Needs tab */
    .month-needs-container {
      display: flex;
      flex-wrap: wrap; /* Allow wrapping on smaller screens */
      gap: 30px;
      justify-content: space-around;
      margin-top: 20px;
    }

    .month-needs-section {
      flex: 1; /* Distribute space equally */
      min-width: 300px; /* Minimum width before wrapping */
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #f9f9f9;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    body.dark-mode .month-needs-section {
      background-color: #2a2a2a;
      border-color: #444;
    }

    .month-needs-section h3 {
      margin-top: 0;
      color: #00796b;
      text-align: center;
    }

    body.dark-mode .month-needs-section h3 {
      color: #80cbc4;
    }

    .month-needs-section select {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    body.dark-mode .month-needs-section select {
      background-color: #3e3e3e;
      color: #e0e0e0;
      border-color: #555;
    }

    .month-needs-section ul {
      list-style-type: none;
      padding: 0;
      columns: 2; /* Two columns for lists */
      column-gap: 20px;
      max-height: 400px; /* Limit height for scrollability */
      overflow-y: auto; /* Add scrollbar if content overflows */
      border: 1px solid #eee;
      padding: 10px;
      border-radius: 5px;
      background-color: #fff;
    }

    body.dark-mode .month-needs-section ul {
      background-color: #1a1a1a;
      border-color: #333;
    }

    .month-needs-section ul li {
      padding: 5px 0;
      border-bottom: 1px dashed #eee;
    }

    body.dark-mode .month-needs-section ul li {
      border-bottom: 1px dashed #3a3a3a;
    }

    .month-needs-section ul li:last-child {
      border-bottom: none;
    }

    #totalMonthsSpeciesCount {
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 20px;
      color: #004d40;
    }

    body.dark-mode #totalMonthsSpeciesCount {
      color: #b2dfdb;
    }

  </style>
</head>
<body>

  <h2>üê¶ Michigan eBird Summary Program</h2>

  <div class="tabs">
    <div class="tab active" data-tab="upload">Upload</div>
    <div class="tab" data-tab="table">County Totals</div>
	<div class="tab" data-tab="speciesByCounty">Species by County</div>
    <div class="tab" data-tab="monthly">Monthly Totals</div>
    <div class="tab" data-tab="bigyear">Year Totals</div>
    <div class="tab" data-tab="bigmonth">Month Totals by Year</div>
	<div class="tab" data-tab="life">Regional Life/Ticks</div>
	<div class="tab" data-tab="speciesByYear">Species by Year</div>
    <div class="tab" data-tab="monthNeeds">Month Needs</div> <!-- New Tab -->
  </div>

  <div id="upload" class="tab-content active">
    <input type="file" id="csvFile" accept=".csv,.zip">
    <button id="themeToggle" style="margin-left: 15px;">Switch to Dark Mode</button>
    <p>Download your eBird data by logging into your eBird account. Go to My eBird. On the bottom left of the page you should see Download My Data.
	Click the Submit button. You will get an email with a link. Click the link in the email and the data will be downloaded to your computer.
	You can then upload the zip file or the extracted csv file to this program. <br><br>Click the Choose File button above and navigate to
	your file on your computer to load it. The Michigan eBird Summary program will remove all non-Michigan data then process the remaining data.
	</p><br>
	
	The program should only take a second or two to run. Navigate through the tabs to see your
	data.
	</p>
	<p> Beta version 0.3.2</p><br>
	<p> Last updated August 10, 2025<p>
    <p><a href="Readme.html" target="_blank">Click here to view the Readme file </a></p>
</div>

  <div id="table" class="tab-content">
    <div id="summaryBox" style="font-weight: bold; margin-bottom: 15px;"></div>
	<p><b>***Click on either column heading to sort</b></p>
    <table id="resultTable">
      <thead>
        <tr>
          <th data-key="county">County</th>
          <th data-key="count">Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="monthly" class="tab-content">
    <table id="monthlyTable">
      <thead>
        <tr>
          <th>Month</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="bigyear" class="tab-content">
  <p><b>***Click on either column heading to sort</b></p>
    <table id="bigYearTable">
      <thead>
        <tr>
          <th>Year</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  
<div id="life" class="tab-content">
  <h3>Regional Summary</h3>
<table class="life-summary-table">
 <thead>
  <tr>
    <th>Region</th>
    <th>Species Count</th>
    <th>Total Ticks</th>
  </tr>
</thead>

  <tbody>
    <tr><td>Lower Peninsula</td><td id="lowerPeninsulaCount"></td><td id="lowerPeninsulaTicks"></td></tr>
    <tr><td>Upper Peninsula</td><td id="upperPeninsulaCount"></td><td id="upperPeninsulaTicks"></td></tr>
    <tr><td>Saginaw Bay (Arenac, Bay, Huron Iosco, Midland, Saginaw and Tuscola) </td><td id="saginawBayCount"></td><td id="saginawBayTicks"></td></tr>
    <tr><td>Detroit Metro (Wayne, Oakland, Macomb)</td><td id="detroitMetroCount"></td><td id="detroitMetroTicks"></td></tr>
    <tr><td>Capitol Area (Clinton, Eaton, Ingham)</td><td id="capitolAreaCount"></td><td id="capitolAreaTicks"></td></tr>
    <tr><td>Northern Lower Peninsula (Oceana to Bay & North)</td><td id="northernLowerPeninsulaCount"></td><td id="northernLowerPeninsulaTicks"></td></tr>
    <tr><td>Southern Lower Peninsula (Muskegon to Saginaw & South)</td><td id="southernLowerPeninsulaCount"></td><td id="southernLowerPeninsulaTicks"></td></tr>
	<tr><td>Keweenaw Peninsula (Keweenaw, Houghton, Baraga)</td><td id="keweenawPeninsulaCount"></td><td id="keweenawPeninsulaTicks"></td></tr>
	<tr><td>HCMA Metroparks</td><td id="hcmaMetroparksCount"></td><td>-</td></tr>
  </tbody>
</table>

</div>


<div id="bigmonth" class="tab-content">
  <table id="bigMonthTable">
    <thead>
      <tr>
        <th>Year</th>
	<th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th>
	<th>May</th><th>Jun</th><th>Jul</th><th>Aug</th>
	<th>Sep</th><th>Oct</th><th>Nov</th><th>Dec</th>
	<th>Total</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="speciesByYear" class="tab-content">
 <label for="yearSelector"><strong>Select Year:</strong></label>
<select id="yearSelector"></select>
<span id="yearSpeciesCount" style="margin-left: 10px; font-weight: bold;"></span>
<button id="sortToggle" style="margin-left: 15px;">Sort: A ‚Üí Z</button>

  <ul id="speciesList" style="margin-top: 20px; columns: 3;"></ul>
</div>

<div id="speciesByCounty" class="tab-content">
  <label for="countySelector"><strong>Select County:</strong></label>
<select id="countySelector"></select>
<span id="countySpeciesCount" style="margin-left: 10px; font-weight: bold;"></span>
<button id="countySortToggle" style="margin-left: 15px;">Sort: Taxonomic</button>


  <ul id="countySpeciesList" style="margin-top: 20px; columns: 3;"></ul>
</div>

<!-- New Month Needs Tab Content -->
<div id="monthNeeds" class="tab-content">
  <div id="totalMonthsSpeciesCount"></div>
  <div class="month-needs-container">
    <div class="month-needs-section">
      <h3>Species Not Seen in Selected Month</h3>
      <label for="monthNeedsMonthSelector">Select Month:</label>
      <select id="monthNeedsMonthSelector"></select>
      <ul id="monthNeedsSpeciesMissingList"></ul>
    </div>
    <div class="month-needs-section">
      <h3>Months Seen / Not Seen for a Species</h3>
      <label for="monthNeedsSpeciesSelector">Select Species:</label>
      <select id="monthNeedsSpeciesSelector"></select>
      <h4>Months Seen:</h4>
      <ul id="monthNeedsSpeciesSeenList"></ul>
      <h4>Months Not Seen:</h4>
      <ul id="monthNeedsSpeciesNotSeenList"></ul>
    </div>
  </div>
</div>
<!-- End New Month Needs Tab Content -->


  <script>
    // Tab Switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

  document.getElementById('csvFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  if (file.name.endsWith('.zip')) {
    const zipReader = new FileReader();
    zipReader.onload = function(evt) {
      JSZip.loadAsync(evt.target.result).then(zip => {
        const csvFileName = Object.keys(zip.files).find(name => name.toLowerCase().endsWith("myebirddata.csv"));
        if (!csvFileName) {
          // Changed alert to a modal message
          showMessageBox("MyEBirdData.csv not found in ZIP file.");
          return;
        }
        zip.files[csvFileName].async("string").then(csvText => {
          parseCsv(csvText);
        });
      });
    };
    zipReader.readAsArrayBuffer(file);
  } else {
    const reader = new FileReader();
    reader.onload = function(event) {
      parseCsv(event.target.result);
    };
    reader.readAsText(file);
  }
});

    let currentData = [];
    // Data structures for Month Needs tab
    let allUniqueSpecies = new Set();
    let speciesByMonth = new Map(); // Map: monthIndex (0-11) -> Set<speciesName>
    let monthsBySpecies = new Map(); // Map: speciesName -> Set<monthIndex (0-11)>

	let lowerTicks = 0, upperTicks = 0, northernLowerTicks = 0, southernLowerTicks = 0;
    let saginawTicks = 0, detroitTicks = 0, capitolTicks = 0, keweenawTicks = 0;
	let speciesSortMode = "taxo"; // "alpha" or "taxo"
	let taxonomicOrderMap = {};

  // Custom message box instead of alert
  function showMessageBox(message) {
    const messageBox = document.createElement('div');
    messageBox.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 1000;
      border-radius: 8px;
      text-align: center;
      font-family: sans-serif;
      color: #333;
    `;
    messageBox.innerHTML = `
      <p>${message}</p>
      <button style="margin-top: 15px; padding: 10px 20px; border: none; background-color: #00796b; color: white; border-radius: 5px; cursor: pointer;">OK</button>
    `;
    document.body.appendChild(messageBox);

    messageBox.querySelector('button').addEventListener('click', () => {
      document.body.removeChild(messageBox);
    });
  }
  
 function parseDateStrict(dateStr) {
  if (!dateStr || typeof dateStr !== "string") return NaN;

  // Handle Excel epoch bug
  if (dateStr === "1/1/1900" || dateStr === "1900-01-01") {
    return new Date(Date.UTC(1900, 0, 1));
  }

  let date;

  // Try MM/DD/YYYY format
  if (dateStr.includes('/')) {
    const [month, day, year] = dateStr.split('/').map(Number);
    if (!month || !day || !year) return NaN;
    // Create the date in UTC to prevent any timezone shifts
    date = new Date(Date.UTC(year, month - 1, day));
    if (
      date.getUTCFullYear() !== year ||
      date.getUTCMonth() !== (month - 1) ||
      date.getUTCDate() !== day
    ) return NaN;
  }

  // Try ISO format YYYY-MM-DD
  else if (dateStr.includes('-')) {
    // Append 'T00:00:00Z' to explicitly force UTC interpretation
    date = new Date(dateStr + 'T00:00:00Z');
    if (isNaN(date)) return NaN;
  }

  return date;
}

    function renderTable(data) {
      const tbody = document.querySelector('#resultTable tbody');
      tbody.innerHTML = '';
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.county}</td><td>${row.count}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderSummary(data) {
      const grandTotal = data.reduce((acc, row) => acc + row.count, 0);
      const thresholds = [300, 250, 200, 150, 100];
      const counts = thresholds.map(thresh => {
        return `Counties ‚â• ${thresh}: ${data.filter(row => row.count >= thresh).length}`;
      });
      document.getElementById('summaryBox').innerHTML =
        `Total County Ticks: ${grandTotal} | ${counts.join(" | ")}`;
    }

    function renderMonthlyTable(data) {
      const monthlyMap = Array.from({ length: 12 }, () => new Set());

      data.forEach(row => {
        const dateStr = row["Date"];
        const common = row["Common Name"];
        const date = parseDateStrict(dateStr);

    // Skip exactly 1/1/1900
    if (
     !isNaN(date) &&
     !(date.getUTCFullYear() === 1900 && date.getUTCMonth() === 0 && date.getUTCDate() === 1) &&
     common
    ) {
     const month = date.getUTCMonth();
     monthlyMap[month].add(common);
   }
    });

      const months = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
	  
      const result = months.map((month, i) => ({
        month,
        count: monthlyMap[i].size
      }));

      const tbody = document.querySelector('#monthlyTable tbody');
      tbody.innerHTML = '';
      result.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.month}</td><td>${row.count}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderBigYearTable(data) {
      const yearMap = {};

      data.forEach(row => {
        const dateStr = row["Date"];
        const common = row["Common Name"];
        const date = parseDateStrict(dateStr);
        const year = date.getUTCFullYear();
        if (!isNaN(year) && common) {
          if (!yearMap[year]) yearMap[year] = new Set();
          yearMap[year].add(common);
        }
      });

      let bigYearData = Object.keys(yearMap)
	  .map(year => parseInt(year))
	  .sort((a, b) => b - a)
 	  .map(year => ({
   	  year,
        count: yearMap[year].size
           }));


      renderBigYearTableBody(bigYearData);

      const ths = document.querySelectorAll('#bigYearTable th');
      ths.forEach(th => th.classList.remove('sort-asc', 'sort-desc'));
      ths[0].classList.add('sort-desc'); // Highlight Year column as descending


      ths.forEach(th => {
        th.addEventListener('click', function () {
          const key = th.innerText.includes("Year") ? "year" : "count";
          const isAsc = !th.classList.contains('sort-asc');

          ths.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
          th.classList.add(isAsc ? 'sort-asc' : 'sort-desc');

          bigYearData.sort((a, b) => {
            return isAsc ? a[key] - b[key] : b[key] - a[key];
          });

          renderBigYearTableBody(bigYearData);
        });
      });
    }

    function renderBigYearTableBody(data) {
      const tbody = document.querySelector('#bigYearTable tbody');
      tbody.innerHTML = '';
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.year}</td><td>${row.count}</td>`;
        tbody.appendChild(tr);
      });
    }

    document.querySelectorAll('#resultTable th').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.dataset.key;
        const isAsc = !th.classList.contains('sort-asc');

        document.querySelectorAll('#resultTable th').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
        th.classList.add(isAsc ? 'sort-asc' : 'sort-desc');

        const sorted = [...currentData].sort((a, b) => {
          if (key === 'count') return isAsc ? a.count - b.count : b.count - a.count;
          return isAsc ? a.county.localeCompare(b.county) : b.county.localeCompare(a.county);
        });

        renderTable(sorted);
      });
    });

function renderBigMonthTable(data) {
  const monthMap = {}; // year -> [Set of common names for month 0-11]

  data.forEach(row => {
    const date = parseDateStrict(row["Date"]);
    const month = date.getUTCMonth(); // Use getUTCMonth()
    const year = date.getUTCFullYear(); // Use getUTCFullYear()
    const species = row["Common Name"];

    // Skip exactly 1/1/1900
    if (
      !isNaN(year) &&
      !isNaN(month) &&
      species &&
      !(year === 1900 && month === 0 && date.getUTCDate() === 1)
    ) {
      if (!monthMap[year]) {
        monthMap[year] = Array.from({ length: 12 }, () => new Set());
      }
      monthMap[year][month].add(species);
    }
  });

 const sortedYears = Object.keys(monthMap).map(Number).sort((a, b) => b - a);
  const tbody = document.querySelector('#bigMonthTable tbody');
  tbody.innerHTML = '';

  sortedYears.forEach(year => {
    const monthSets = monthMap[year];
    const counts = monthSets.map(set => set.size);
    const total = counts.reduce((sum, val) => sum + val, 0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${year}</td>` + counts.map(c => `<td>${c}</td>`).join('') + `<td>${total}</td>`;

    tbody.appendChild(tr);
  });
}

function renderLifeTab(data) {
  const lowerPeninsulaCounties = new Set([
    "Alcona", "Allegan", "Alpena", "Antrim", "Arenac", "Barry", "Bay", "Benzie", "Berrien",
    "Branch", "Calhoun", "Cass", "Charlevoix", "Cheboygan", "Clare", "Clinton", "Crawford",
    "Eaton", "Emmet", "Genesee", "Gladwin", "Grand Traverse", "Gratiot", "Hillsdale", "Huron",
    "Ingham", "Ionia", "Iosco", "Isabella", "Jackson", "Kalamazoo", "Kalkaska", "Kent", "Lake",
    "Lapeer", "Leelanau", "Lenawee", "Livingston", "Macomb", "Manistee", "Mason", "Mecosta",
    "Midland", "Missaukee", "Monroe", "Montcalm", "Montmorency", "Muskegon", "Newaygo",
    "Oakland", "Oceana", "Ogemaw", "Osceola", "Oscoda", "Otsego", "Ottawa", "Presque Isle",
    "Roscommon", "Saginaw", "Sanilac", "Shiawassee", "St. Clair", "St. Joseph", "Tuscola",
    "Van Buren", "Washtenaw", "Wayne", "Wexford"
  ]);
    
  const northernLowerPeninsulaCounties = new Set([
    "Alcona", "Alpena", "Antrim", "Arenac", "Bay", "Benzie", 
    "Charlevoix", "Cheboygan", "Clare", "Crawford", "Emmet", 
    "Gladwin", "Grand Traverse", "Iosco", "Isabella", 
    "Kalkaska", "Lake", "Leelanau", "Manistee", "Mason", 
    "Mecosta", "Midland", "Missaukee", "Montmorency", "Newaygo", 
    "Oceana", "Ogemaw", "Osceola", "Oscoda", "Otsego", 
    "Presque Isle", "Roscommon", "Wexford"
]);

const southernLowerPeninsulaCounties = new Set([
  "Allegan", "Barry", "Berrien", "Branch", "Calhoun", "Cass", "Clinton", "Eaton", "Genesee",
  "Gratiot", "Hillsdale", "Huron", "Ingham", "Ionia", "Jackson", "Kalamazoo", "Lapeer", "Kent", 
  "Lenawee", "Livingston", "Macomb", "Monroe", "Montcalm", "Muskegon", "Oakland", "Ottawa",
  "Saginaw", "Sanilac", "Shiawassee", "St. Clair", "St. Joseph", "Tuscola", "Van Buren",
  "Washtenaw", "Wayne"
]);

const keweenawPeninsulaCounties = new Set([
  "Keweenaw", "Baraga", "Houghton"
]);

  const upperPeninsulaCounties = new Set([
    "Alger", "Baraga", "Chippewa", "Delta", "Dickinson", "Gogebic", "Houghton",
    "Iron", "Keweenaw", "Luce", "Mackinac", "Marquette", "Menominee", "Ontonagon", "Schoolcraft"
  ]);

  const saginawBayCounties = new Set([
    "Arenac", "Bay", "Huron", "Iosco", "Midland", "Saginaw", "Tuscola"
  ]);

  const detroitMetroCounties = new Set([
    "Wayne", "Oakland", "Macomb"
  ]);

  const capitolAreaCounties = new Set([
    "Clinton", "Eaton", "Ingham"
  ]);

  const lowerSet = new Set();
  const upperSet = new Set();
  const northernLowerSet = new Set();
  const southernLowerSet = new Set();
  const saginawSet = new Set();
  const detroitSet = new Set();
  const capitolSet = new Set();
  const keweenawSet = new Set();

const countySpeciesMap = {};
data.forEach(row => {
  const county = row["County"];
  const name = row["Common Name"];
  if (!county || !name) return;

  if (!countySpeciesMap[county]) {
    countySpeciesMap[county] = new Set();
  }
  countySpeciesMap[county].add(name);
});

function sumRegionTicks(regionSet) {
  let total = 0;
  regionSet.forEach(county => {
    if (countySpeciesMap[county]) {
      total += countySpeciesMap[county].size;
    }
  });
  return total;
}

const lowerTicks = sumRegionTicks(lowerPeninsulaCounties);
const upperTicks = sumRegionTicks(upperPeninsulaCounties);
const northernLowerTicks = sumRegionTicks(northernLowerPeninsulaCounties);
const southernLowerTicks = sumRegionTicks(southernLowerPeninsulaCounties);
const saginawTicks = sumRegionTicks(saginawBayCounties);
const detroitTicks = sumRegionTicks(detroitMetroCounties);
const capitolTicks = sumRegionTicks(capitolAreaCounties);
const keweenawTicks = sumRegionTicks(keweenawPeninsulaCounties);

  data.forEach(row => {
    const county = row["County"];
    const name = row["Common Name"];
    if (!name) return;
    if (lowerPeninsulaCounties.has(county)) lowerSet.add(name);
    if (upperPeninsulaCounties.has(county)) upperSet.add(name);
	if (northernLowerPeninsulaCounties.has(county)) northernLowerSet.add(name);
	if (southernLowerPeninsulaCounties.has(county)) southernLowerSet.add(name);
    if (saginawBayCounties.has(county)) saginawSet.add(name);
    if (detroitMetroCounties.has(county)) detroitSet.add(name);
    if (capitolAreaCounties.has(county)) capitolSet.add(name);
	if (keweenawPeninsulaCounties.has(county)) keweenawSet.add(name);
  });
  
   const hcmaSet = new Set();

  data.forEach(row => {
    const name = row["Common Name"];
    const location = row["Location"];
    if (name && location && location.toLowerCase().includes("metropark")) {
      hcmaSet.add(name);
    }
  });

document.getElementById("hcmaMetroparksCount").innerText = hcmaSet.size.toLocaleString();
document.getElementById("lowerPeninsulaCount").innerText = lowerSet.size.toLocaleString();
document.getElementById("upperPeninsulaCount").innerText = upperSet.size.toLocaleString();
document.getElementById("northernLowerPeninsulaCount").innerText = northernLowerSet.size.toLocaleString();
document.getElementById("southernLowerPeninsulaCount").innerText = southernLowerSet.size.toLocaleString();
document.getElementById("saginawBayCount").innerText = saginawSet.size.toLocaleString();
document.getElementById("detroitMetroCount").innerText = detroitSet.size.toLocaleString();
document.getElementById("capitolAreaCount").innerText = capitolSet.size.toLocaleString();
document.getElementById("keweenawPeninsulaCount").innerText = keweenawSet.size.toLocaleString();
document.getElementById("lowerPeninsulaTicks").innerText = lowerTicks.toLocaleString();
document.getElementById("upperPeninsulaTicks").innerText = upperTicks.toLocaleString();
document.getElementById("northernLowerPeninsulaTicks").innerText = northernLowerTicks.toLocaleString();
document.getElementById("southernLowerPeninsulaTicks").innerText = southernLowerTicks.toLocaleString();
document.getElementById("saginawBayTicks").innerText = saginawTicks.toLocaleString();
document.getElementById("detroitMetroTicks").innerText = detroitTicks.toLocaleString();
document.getElementById("capitolAreaTicks").innerText = capitolTicks.toLocaleString();
document.getElementById("keweenawPeninsulaTicks").innerText = keweenawTicks.toLocaleString();

}

function renderSpeciesByYear(data) {
  const yearMap = {};

  data.forEach(row => {
    const dateStr = row["Date"];
    const name = row["Common Name"];
    const date = parseDateStrict(dateStr);
    const year = date.getUTCFullYear();
    if (!isNaN(year) && name) {
      if (!yearMap[year]) yearMap[year] = new Set();
      yearMap[year].add(name);
    }
  });

  const selector = document.getElementById("yearSelector");
  const list = document.getElementById("speciesList");
  const countSpan = document.getElementById("yearSpeciesCount");
  const toggleButton = document.getElementById("sortToggle");

  selector.innerHTML = '';
  const sortedYears = Object.keys(yearMap).sort((a, b) => b - a);
  sortedYears.forEach(y => {
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    selector.appendChild(opt);
  });

  function updateSpeciesList(year) {
    const species = Array.from(yearMap[year]);

    if (speciesSortMode === "alpha") {
      species.sort();
    } else {
      species.sort((a, b) => {
        const rankA = taxonomicOrderMap[a] ?? 9999;
        const rankB = taxonomicOrderMap[b] ?? 9999;
        return rankA - rankB || a.localeCompare(b);
      });
    }

    countSpan.textContent = `Species Count: ${species.length}`;
    list.innerHTML = '';
    species.forEach(name => {
      const li = document.createElement('li');
      li.textContent = name;
      list.appendChild(li);
    });
  }

  selector.addEventListener('change', function () {
    updateSpeciesList(this.value);
  });

  toggleButton.addEventListener('click', function () {
    speciesSortMode = speciesSortMode === "alpha" ? "taxo" : "alpha";
    this.textContent = `Sort: ${speciesSortMode === "alpha" ? "Taxonomic" : "A ‚Üí Z"}`;
    updateSpeciesList(selector.value);
  });

  if (sortedYears.length > 0) {
    selector.value = sortedYears[0];
    updateSpeciesList(sortedYears[0]);
  }
}


function renderSpeciesByCounty(data) {
  const countyMap = {};

  data.forEach(row => {
    const name = row["Common Name"];
    const county = row["County"];
    if (!county || !name) return;
    if (!countyMap[county]) countyMap[county] = new Set();
    countyMap[county].add(name);
  });

  const selector = document.getElementById("countySelector");
  const list = document.getElementById("countySpeciesList");
  const countSpan = document.getElementById("countySpeciesCount");
  const toggleButton = document.getElementById("countySortToggle");

  selector.innerHTML = '';
  const sortedCounties = Object.keys(countyMap).sort();

  sortedCounties.forEach(county => {
    const opt = document.createElement('option');
    opt.value = county;
    opt.textContent = county;
    selector.appendChild(opt);
  });

  function updateCountySpeciesList(county) {
    const species = Array.from(countyMap[county] || []);

    if (speciesSortMode === "alpha") {
      species.sort();
    } else {
      species.sort((a, b) => {
        const rankA = taxonomicOrderMap[a] ?? 9999;
        const rankB = taxonomicOrderMap[b] ?? 9999;
        return rankA - rankB || a.localeCompare(b);
      });
    }

    countSpan.textContent = `Species Count: ${species.length}`;
    list.innerHTML = '';
    species.forEach(name => {
      const li = document.createElement('li');
      li.textContent = name;
      list.appendChild(li);
    });
  }

  selector.addEventListener('change', function () {
    updateCountySpeciesList(this.value);
  });

  toggleButton.addEventListener('click', function () {
    speciesSortMode = speciesSortMode === "alpha" ? "taxo" : "alpha";
    this.textContent = `Sort: ${speciesSortMode === "alpha" ? "Taxonomic" : "A ‚Üí Z"}`;
    updateCountySpeciesList(selector.value);
  });

  if (sortedCounties.length > 0) {
    selector.value = sortedCounties[0];
    toggleButton.textContent = `Sort: ${speciesSortMode === "alpha" ? "Taxonomic" : "A ‚Üí Z"}`;
    updateCountySpeciesList(sortedCounties[0]);
  }
}

function parseCsv(text) {
  const parsed = Papa.parse(text, {
    header: true,
    skipEmptyLines: true
  });

  const data = parsed.data;

  // üåø Capture first-seen order for taxonomic sorting
  taxonomicOrderMap = {};
  let taxoIndex = 0;
  data.forEach(row => {
    const name = row["Common Name"];
    if (name && !(name in taxonomicOrderMap)) {
      taxonomicOrderMap[name] = taxoIndex++;
    }
  });

  // Define the set of species to filter out
  const speciesToFilterOut = new Set([
    "Graylag Goose",
    "Swan Goose",
    "Ruddy Shelduck",
    "Muscovy Duck",
    "Indian Peafowl",
    "Red Junglefowl",
    "Chukar",
    "Budgerigar",
    "European Goldfinch",
    "Whooping Crane"
  ]);

  // ‚úÖ Filter first, before parsing dates
  const filtered = data.filter(row => {
    const state = row["State/Province"];
    let common = row["Common Name"];

    if (state !== "US-MI" || !common) return false;

    // Filter out specified species
    if (speciesToFilterOut.has(common)) {
        return false;
    }

    // Special filter for Northern Bobwhite on or after 1/1/2020
    if (common === "Northern Bobwhite") {
        const date = parseDateStrict(row["Date"]);
        const filterDate = new Date(Date.UTC(2020, 0, 1));
        if (!isNaN(date) && date >= filterDate) {
            return false;
        }
    }

    // Remove hybrids/domestic species
    if (common.includes("(") && common.includes(")")) {
      const match = common.match(/\(([^)]+)\)/);
      if (match) {
        const parensText = match[1].toLowerCase();
        if (parensText.includes("hybrid") || parensText.includes("domestic")) {
          return false;
        }
      }

      // Remove parenthesis text
      row["Common Name"] = common.replace(/\s*\([^)]*\)/g, '').trim();
      common = row["Common Name"];
    }

    return !common.includes("/") && !common.includes("sp.");
  });

  // Clear previous data for month needs tab to ensure fresh data on re-upload
  allUniqueSpecies.clear();
  speciesByMonth.clear();
  monthsBySpecies.clear();

  // Populate data structures for Month Needs tab (allUniqueSpecies, speciesByMonth, monthsBySpecies)
  filtered.forEach(row => {
    const date = parseDateStrict(row["Date"]);
    const speciesName = row["Common Name"];

    // üÜï Add an explicit check for the 1900 date before processing.
    if (
        !isNaN(date) &&
        speciesName &&
        !(date.getUTCFullYear() === 1900 && date.getUTCMonth() === 0 && date.getUTCDate() === 1)
    ) {
      // Add to the set of all unique species encountered
      allUniqueSpecies.add(speciesName);

      const monthIndex = date.getUTCMonth(); // Get month in UTC

      // Populate speciesByMonth map: monthIndex -> Set<speciesName>
      if (!speciesByMonth.has(monthIndex)) {
        speciesByMonth.set(monthIndex, new Set());
      }
      speciesByMonth.get(monthIndex).add(speciesName);

      // Populate monthsBySpecies map: speciesName -> Set<monthIndex>
      if (!monthsBySpecies.has(speciesName)) {
        monthsBySpecies.set(speciesName, new Set());
      }
      monthsBySpecies.get(speciesName).add(monthIndex);
    }
  });


  // üõ° Optional: log invalid dates only within filtered rows
  filtered.forEach((row, i) => {
    const date = parseDateStrict(row["Date"]);
    if (isNaN(date)) {
      console.warn(`‚õî Invalid date at row ${i + 1}: "${row["Date"]}" (${row["Common Name"]})`);
    }
  });

  // ‚úÖ Proceed with analysis using only the filtered rows
  const countyMap = {};
  filtered.forEach(row => {
    const county = row["County"];
    const name = row["Common Name"];
    if (!countyMap[county]) countyMap[county] = new Set();
    countyMap[county].add(name);
  });

  currentData = Object.entries(countyMap).map(([county, names]) => ({
    county,
    count: names.size
  }));

  // Render all the tables and lists
  renderTable(currentData);
  renderSummary(currentData);
  renderMonthlyTable(filtered);
  renderBigYearTable(filtered);
  renderBigMonthTable(filtered);
  renderLifeTab(filtered);
  renderSpeciesByYear(filtered);
  renderSpeciesByCounty(filtered);
  renderMonthNeedsTab(); // Call the function to render the new tab

  // Default behavior: sort by county, switch to County Totals tab
  document.querySelector('#resultTable th[data-key="county"]').click();
  document.querySelector('.tab[data-tab="table"]').click();
}

// --- New JavaScript functions for Month Needs tab ---
function renderMonthNeedsTab() {
  const months = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];

  // Calculate the new "Total Species Seen in all 12 Months"
  let speciesSeenInAll12MonthsCount = 0;
  allUniqueSpecies.forEach(speciesName => {
    const seenMonthsForSpecies = monthsBySpecies.get(speciesName);
    // A species counts if it has been seen in all 12 unique months (0-11)
    if (seenMonthsForSpecies && seenMonthsForSpecies.size === 12) {
      speciesSeenInAll12MonthsCount++;
    }
  });

  document.getElementById('totalMonthsSpeciesCount').textContent =
    `Total Species Seen in all 12 Months: ${speciesSeenInAll12MonthsCount}`;

  // Left Section: Species Not Seen in Selected Month
  const monthSelector = document.getElementById('monthNeedsMonthSelector');
  const speciesMissingList = document.getElementById('monthNeedsSpeciesMissingList');

  monthSelector.innerHTML = '';
  months.forEach((monthName, index) => {
    const opt = document.createElement('option');
    opt.value = index;
    opt.textContent = monthName;
    monthSelector.appendChild(opt);
  });

  function updateSpeciesMissingList() {
    const selectedMonthIndex = parseInt(monthSelector.value);
    const speciesSeenInMonth = speciesByMonth.get(selectedMonthIndex) || new Set();
    
    const missingSpecies = Array.from(allUniqueSpecies).filter(species => {
      return !speciesSeenInMonth.has(species);
    }).sort(); // Sort alphabetically

    speciesMissingList.innerHTML = '';
    if (missingSpecies.length === 0) {
      const li = document.createElement('li');
      li.textContent = "All unique species seen in this month!";
      speciesMissingList.appendChild(li);
    } else {
      missingSpecies.forEach(species => {
        const li = document.createElement('li');
        li.textContent = species;
        speciesMissingList.appendChild(li);
      });
    }
  }
  
  monthSelector.addEventListener('change', updateSpeciesMissingList);

  // Right Section: Months Seen / Not Seen for a Species
  const speciesSelector = document.getElementById('monthNeedsSpeciesSelector');
  const speciesSeenList = document.getElementById('monthNeedsSpeciesSeenList');
  const speciesNotSeenList = document.getElementById('monthNeedsSpeciesNotSeenList');

  speciesSelector.innerHTML = '';
  const sortedSpecies = Array.from(allUniqueSpecies).sort();
  sortedSpecies.forEach(speciesName => {
    const opt = document.createElement('option');
    opt.value = speciesName;
    opt.textContent = speciesName;
    speciesSelector.appendChild(opt);
  });

  function updateSpeciesMonthCoverage() {
    const selectedSpecies = speciesSelector.value;
    const seenMonthsForSpecies = monthsBySpecies.get(selectedSpecies) || new Set();

    speciesSeenList.innerHTML = '';
    speciesNotSeenList.innerHTML = '';

    const tempSeenMonths = [];
    const tempNotSeenMonths = [];

    months.forEach((monthName, index) => {
      if (seenMonthsForSpecies.has(index)) {
        tempSeenMonths.push(monthName);
      } else {
        tempNotSeenMonths.push(monthName);
      }
    });

    if (tempSeenMonths.length === 0) {
      const li = document.createElement('li');
      li.textContent = "Not seen in any month yet.";
      speciesSeenList.appendChild(li);
    } else {
      tempSeenMonths.forEach(monthName => {
        const li = document.createElement('li');
        li.textContent = monthName;
        speciesSeenList.appendChild(li);
      });
    }

    if (tempNotSeenMonths.length === 0) {
      const li = document.createElement('li');
      li.textContent = "Seen in all 12 months!";
      speciesNotSeenList.appendChild(li);
    } else {
      tempNotSeenMonths.forEach(monthName => {
        const li = document.createElement('li');
        li.textContent = monthName;
        speciesNotSeenList.appendChild(li);
      });
    }
  }

  speciesSelector.addEventListener('change', updateSpeciesMonthCoverage);

  // Initial display for both sections
  if (months.length > 0) {
    monthSelector.value = 0; // Select January by default
    updateSpeciesMissingList();
  }
  if (sortedSpecies.length > 0) {
    speciesSelector.value = sortedSpecies[0]; // Select first species by default
    updateSpeciesMonthCoverage();
  } else {
    // Handle case where no species data is loaded yet
    speciesMissingList.innerHTML = '<li>Upload your eBird data to see results.</li>';
    speciesSeenList.innerHTML = '<li>Upload your eBird data to see results.</li>';
    speciesNotSeenList.innerHTML = '<li>Upload your eBird data to see results.</li>';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  // Dark Mode Toggle
  const themeToggleBtn = document.getElementById('themeToggle');
  const body = document.body;

  // Check for saved theme preference
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    body.classList.add('dark-mode');
    themeToggleBtn.textContent = 'Switch to Light Mode';
  } else {
    themeToggleBtn.textContent = 'Switch to Dark Mode';
  }

  themeToggleBtn.addEventListener('click', () => {
    body.classList.toggle('dark-mode');
    if (body.classList.contains('dark-mode')) {
      themeToggleBtn.textContent = 'Switch to Light Mode';
      localStorage.setItem('theme', 'dark');
    } else {
      themeToggleBtn.textContent = 'Switch to Dark Mode';
      localStorage.setItem('theme', 'light');
    }
  });
});

  </script>
  
</body>
</html>
